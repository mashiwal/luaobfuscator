<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripture - Lua Code Obfuscator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .editor-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .editor-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .editor-container:hover {
            border-color: #667eea;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
        }

        .editor-label {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        textarea {
            width: 100%;
            height: 300px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            resize: vertical;
            background: white;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(108, 117, 125, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .examples {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .examples h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .example-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .example-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .editor-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Lua Code Obfuscator</h1>
            <p>Advanced encryption-based obfuscation for Lua scripts</p>
        </div>
        
        <div class="main-content">
            <div class="editor-section">
                <div class="editor-container">
                    <div class="editor-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Original Lua Code
                    </div>
                    <textarea id="inputCode" placeholder="Enter your Lua code here..."></textarea>
                </div>
                
                <div class="editor-container">
                    <div class="editor-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                        </svg>
                        Obfuscated Code
                    </div>
                    <textarea id="outputCode" placeholder="Obfuscated code will appear here..." readonly></textarea>
                </div>
            </div>
            
            <div class="controls">
                <button id="obfuscateBtn" class="btn btn-primary">
                    üîí Obfuscate Code
                </button>
                <button id="clearBtn" class="btn btn-secondary">
                    üóëÔ∏è Clear All
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="originalLength">0</div>
                    <div class="stat-label">Original Length</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="obfuscatedLength">0</div>
                    <div class="stat-label">Obfuscated Length</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="compressionRatio">0%</div>
                    <div class="stat-label">Size Ratio</div>
                </div>
            </div>
            
            <div class="examples">
                <h3>üìö Example Scripts</h3>
                <button class="example-btn" onclick="loadExample('hello')">Hello World</button>
                <button class="example-btn" onclick="loadExample('function')">Function Example</button>
                <button class="example-btn" onclick="loadExample('loop')">Loop Example</button>
                <button class="example-btn" onclick="loadExample('complex')">Complex Script</button>
            </div>
        </div>
    </div>

    <script>
        // Crypto polyfill for browser
        function getRandomBytes(length) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return Array.from(array);
        }

        function escapeByteRobustlyForLua(byte, quoteChar = '"') {
            // Handle essential escapes first
            if (byte === 7) return '\\a';
            if (byte === 8) return '\\b';
            if (byte === 9) return '\\t';
            if (byte === 10) return '\\n';
            if (byte === 11) return '\\v';
            if (byte === 12) return '\\f';
            if (byte === 13) return '\\r';
            if (byte === 92) return '\\\\';

            const quoteCharCode = quoteChar.charCodeAt(0);
            if (byte === quoteCharCode) {
                return '\\' + quoteChar;
            }

            // For other characters, decide on representation
            if (byte >= 32 && byte <= 126) {
                const r = Math.random();
                if (r < 0.98) {
                    return String.fromCharCode(byte);
                } else if (r < 0.99) {
                    let hex = byte.toString(16);
                    if (hex.length < 2) hex = '0' + hex;
                    return '\\x' + hex;
                } else {
                    let dec = byte.toString(10);
                    if (dec.length === 1) dec = '00' + dec;
                    else if (dec.length === 2) dec = '0' + dec;
                    return '\\' + dec;
                }
            } else {
                if (Math.random() < 0.5) {
                    let hex = byte.toString(16);
                    if (hex.length < 2) hex = '0' + hex;
                    return '\\x' + hex;
                } else {
                    let dec = byte.toString(10);
                    if (dec.length === 1) dec = '00' + dec;
                    else if (dec.length === 2) dec = '0' + dec;
                    return '\\' + dec;
                }
            }
        }

        function byteArrayToRobustlyEscapedLuaString(byteArray, quoteChar = '"') {
            let result = '';
            for (const byte of byteArray) {
                result += escapeByteRobustlyForLua(byte, quoteChar);
            }
            return result;
        }

        function simpleObfuscate(luaCode) {
            if (typeof luaCode !== 'string') {
                throw new Error("Input Lua code must be a string.");
            }
            if (luaCode.length === 0) {
                return "return nil";
            }

            const keyBytes = getRandomBytes(32);
            const originalCodeBytes = new TextEncoder().encode(luaCode);
            const transformedBytes = [];

            let d_state = 0;
            const KEY_LEN = keyBytes.length;
            const D_STATE_MOD = 299989;

            for (let i = 0; i < originalCodeBytes.length; i++) {
                const originalByte = originalCodeBytes[i];
                const global_byte_idx = i;

                const k_idx1 = (d_state + global_byte_idx * 2) % KEY_LEN;
                const op_add_key = keyBytes[k_idx1];

                const k_idx2 = (Math.floor(d_state / 5) + global_byte_idx * 3) % KEY_LEN;
                const op_xor_key = keyBytes[k_idx2];
                
                const k_idx3 = (Math.floor(d_state / 11) + global_byte_idx * 5) % KEY_LEN;
                const op_sub_key = keyBytes[k_idx3];

                const op_add = (op_add_key + (d_state % 70)) % 256;
                const op_xor = (op_xor_key ^ (Math.floor(d_state / 3) % 256)) % 256;
                const op_sub = (op_sub_key + global_byte_idx) % 256;

                let transformed = originalByte;
                transformed = (transformed + op_add) % 256;
                transformed = transformed ^ op_xor;
                transformed = (transformed - op_sub + 512) % 256;

                transformedBytes.push(transformed);
                
                d_state = (d_state * 7 + originalByte + transformed + op_add_key + op_xor_key + global_byte_idx * 13) % D_STATE_MOD;
            }

            const payloadChunks = [];
            const CHUNK_SIZE_MIN = 1;
            const CHUNK_SIZE_MAX = 10;
            let currentByte = 0;
            
            while(currentByte < transformedBytes.length) {
                const chunkSize = CHUNK_SIZE_MIN + Math.floor(Math.random() * (CHUNK_SIZE_MAX - CHUNK_SIZE_MIN + 1));
                const actualChunkSize = Math.min(chunkSize, transformedBytes.length - currentByte);
                const chunkData = transformedBytes.slice(currentByte, currentByte + actualChunkSize);

                let stringRepresentation = '"';
                for (const byte_val of chunkData) {
                    stringRepresentation += escapeByteRobustlyForLua(byte_val, '"');
                }
                stringRepresentation += '"';
                const stringCost = stringRepresentation.length;

                let tableRepresentation = '{';
                for (let i = 0; i < chunkData.length; i++) {
                    tableRepresentation += chunkData[i].toString();
                    if (i < chunkData.length - 1) {
                        tableRepresentation += ',';
                    }
                }
                tableRepresentation += '}';
                const tableCost = tableRepresentation.length;

                if (chunkData.length === 0) {
                    // skip if chunk is empty
                } else if (stringCost < tableCost) {
                    payloadChunks.push(stringRepresentation);
                } else {
                    payloadChunks.push(tableRepresentation);
                }
                currentByte += actualChunkSize;
            }

            const finalPayloadTableString = `{${payloadChunks.join(',')}}`;
            const finalKeyString = byteArrayToRobustlyEscapedLuaString(keyBytes, '"');
            
            const luaLoader = `(function(P,K)local b,c,t,f,l,y,x=string.byte,string.char,table.concat,math.floor,loadstring,type,bit32 and bit32.bxor;if not x then x=function(a,d)local e,g=0,1;while a>0 and d>0 do local h,i=a%2,d%2;if h~=i then e=e+g end;a,d,g=f(a/2),f(d/2),g*2 end;if a<d then a=d end;while a>0 do if a%2==1 then e=e+g end;a,g=f(a/2),g*2 end;return e end end;local O,kl,X,Y,Y_M,gi={},#K,{},0,${D_STATE_MOD},0;for i=1,kl do X[i]=b(K,i)end;for ci=1,#P do local ch=P[ci];local ct=y(ch);if ct=="table"then for ni=1,#ch do local Cb=ch[ni];local k1i=(Y+gi*2)%kl+1;local ka=X[k1i];local k2i=(f(Y/5)+gi*3)%kl+1;local kx=X[k2i];local k3i=(f(Y/11)+gi*5)%kl+1;local ks=X[k3i];local va=(ka+(Y%70))%256;local vx=(x(kx,(f(Y/3)%256)))%256;local vs=(ks+gi)%256;local Ob=(Cb+vs+512)%256;Ob=x(Ob,vx);Ob=(Ob-va+512)%256;O[#O+1]=c(Ob);Y=(Y*7+Ob+Cb+ka+kx+gi*13)%Y_M;gi=gi+1;end;elseif ct=="string"then for si=1,#ch do local Cb=b(ch,si);local k1i=(Y+gi*2)%kl+1;local ka=X[k1i];local k2i=(f(Y/5)+gi*3)%kl+1;local kx=X[k2i];local k3i=(f(Y/11)+gi*5)%kl+1;local ks=X[k3i];local va=(ka+(Y%70))%256;local vx=(x(kx,(f(Y/3)%256)))%256;local vs=(ks+gi)%256;local Ob=(Cb+vs+512)%256;Ob=x(Ob,vx);Ob=(Ob-va+512)%256;O[#O+1]=c(Ob);Y=(Y*7+Ob+Cb+ka+kx+gi*13)%Y_M;gi=gi+1;end;end;end;return l(t(O))()end)(${finalPayloadTableString},"${finalKeyString}")`;

            return `return loadstring(${luaLoader})()`;
        }

        // Example scripts
        const examples = {
            hello: `print("Hello, World!")
print("This is a simple Lua script!")`,
            
            function: `function greet(name)
    return "Hello, " .. name .. "!"
end

print(greet("Lua Developer"))
print(greet("World"))`,
            
            loop: `for i = 1, 5 do
    print("Iteration " .. i)
    if i % 2 == 0 then
        print("  Even number!")
    else
        print("  Odd number!")
    end
end`,
            
            complex: `-- Complex Lua script with various features
local config = {
    name = "TestApp",
    version = "1.0.0",
    debug = true
}

function log(message)
    if config.debug then
        print("[DEBUG] " .. message)
    end
end

function processData(data)
    local results = {}
    for i, value in ipairs(data) do
        if type(value) == "number" then
            results[i] = value * 2
            log("Processed number: " .. value .. " -> " .. results[i])
        elseif type(value) == "string" then
            results[i] = string.upper(value)
            log("Processed string: " .. value .. " -> " .. results[i])
        end
    end
    return results
end

local testData = {1, 2, "hello", 4, "world", 6}
local processed = processData(testData)

print("Application: " .. config.name .. " v" .. config.version)
print("Processed results:")
for i, v in pairs(processed) do
    print("  [" .. i .. "] = " .. tostring(v))
end`
        };

        function loadExample(type) {
            document.getElementById('inputCode').value = examples[type];
            updateStats();
        }

        function updateStats() {
            const originalCode = document.getElementById('inputCode').value;
            const obfuscatedCode = document.getElementById('outputCode').value;
            
            const originalLength = originalCode.length;
            const obfuscatedLength = obfuscatedCode.length;
            
            document.getElementById('originalLength').textContent = originalLength.toLocaleString();
            document.getElementById('obfuscatedLength').textContent = obfuscatedLength.toLocaleString();
            
            if (originalLength > 0) {
                const ratio = ((obfuscatedLength / originalLength) * 100).toFixed(1);
                document.getElementById('compressionRatio').textContent = ratio + '%';
            } else {
                document.getElementById('compressionRatio').textContent = '0%';
            }
        }

        // Event listeners
        document.getElementById('obfuscateBtn').addEventListener('click', function() {
            const inputCode = document.getElementById('inputCode').value.trim();
            const outputTextarea = document.getElementById('outputCode');
            
            if (!inputCode) {
                outputTextarea.value = 'Please enter some Lua code to obfuscate.';
                return;
            }
            
            try {
                const obfuscated = simpleObfuscate(inputCode);
                outputTextarea.value = obfuscated;
                updateStats();
            } catch (error) {
                outputTextarea.value = 'Error: ' + error.message;
            }
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('inputCode').value = '';
            document.getElementById('outputCode').value = '';
            updateStats();
        });

        document.getElementById('inputCode').addEventListener('input', updateStats);
        document.getElementById('outputCode').addEventListener('input', updateStats);

        // Load initial example
        loadExample('hello');
    </script>
</body>
</html>
